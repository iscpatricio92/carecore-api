# Docker Compose para desarrollo
# Se usa junto con docker-compose.yml base
# Ejemplo: docker-compose -f docker-compose.yml -f docker-compose.development.yml up
# O simplemente: make docker-up (usa este archivo automáticamente cuando NODE_ENV=development)

# En desarrollo, podemos tener configuraciones adicionales como:
# - Volúmenes para hot-reload
# - Servicios adicionales (PgAdmin, etc.)
# - Configuraciones de debugging

services:
  postgres:
    # En desarrollo, podemos exponer más puertos o configuraciones específicas
    # Las variables de entorno vienen de .env.development + .env.local (combinados por Makefile)

  api:
    # En desarrollo, usar el stage "build" que tiene todas las dependencias
    build:
      context: .
      dockerfile: Dockerfile
      target: build
    # Cambiar usuario a root temporalmente para desarrollo (necesario para escribir en volúmenes)
    user: root
    command: npm run start:dev
    volumes:
      # Montar código fuente para hot-reload (no readonly para que pueda escribir archivos temporales)
      - ./src:/app/src
      - ./package.json:/app/package.json:ro
      - ./tsconfig.json:/app/tsconfig.json:ro
      - ./nest-cli.json:/app/nest-cli.json:ro
      # Excluir node_modules del volumen (usar los del contenedor)
      - /app/node_modules
      - /app/dist
    environment:
      NODE_ENV: development
      DB_SYNCHRONIZE: ${DB_SYNCHRONIZE:-true}
    # En desarrollo, no necesitamos healthcheck estricto
    healthcheck:
      test:
        [
          'CMD-SHELL',
          'node -e "require(\"http\").get(\"http://localhost:3000/api\", (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"',
        ]
      interval: 60s
      timeout: 10s
      retries: 3
      start_period: 120s
