# Environment Variables

The project uses an environment-specific variable configuration with loading priority:

1. **`.env.development`** or **`.env.production`** (according to `NODE_ENV`)
2. **`.env.local`** (overrides the above - for local/private values)

## Initial Configuration

### For Development:

1. Copy the development example file:
   ```bash
   cp .env.development.example .env.development
   ```

2. Create your `.env.local` file with values specific to your machine:
   ```bash
   cp .env.development.example .env.local
   ```

   Then edit `.env.local` with your personal values (passwords, secrets, etc.)

3. **IMPORTANT for Docker Compose:**
   Docker Compose now uses the same system as NestJS:
   - Reads first `.env.${NODE_ENV}` (or `.env.development` by default)
   - Then reads `.env.local` if it exists (overrides base file values)
   - Combines both files into `.env.docker` temporarily

   The Makefile automatically combines the files and uses the result with `--env-file`.
   You don't need to create a separate `.env` file.

   ⚠️ **Note:** Environment files must contain the variables `DB_USER`, `DB_PASSWORD`, `DB_NAME`, `DB_PORT`, `KEYCLOAK_ADMIN`, and `KEYCLOAK_ADMIN_PASSWORD`.

### For Production:

1. Copy the production example file:
   ```bash
   cp .env.production.example .env.production
   ```

2. Edit `.env.production` with production values

3. Create `.env.local` to override sensitive values that should not be in the repository

## File Structure

- **`.env.development.example`** - Development template (in repository)
- **`.env.production.example`** - Production template (in repository)
- **`.env.development`** - Values for development (NOT in repository)
  - Used by NestJS when `NODE_ENV=development`
  - Used by Docker Compose when `NODE_ENV=development` (via Makefile)
- **`.env.production`** - Values for production (NOT in repository)
  - Used by NestJS when `NODE_ENV=production`
  - Used by Docker Compose when `NODE_ENV=production` (via Makefile)
- **`.env.local`** - Local values that override everything (NOT in repository)
  - Used by NestJS to override environment file values
  - Used by Docker Compose to override values (combined with base file)
  - Both systems read the base file first and then `.env.local` (which overrides)
- **`.env.docker`** - Temporary file generated by Makefile (NOT in repository)
  - Created automatically by combining `.env.${NODE_ENV}` with `.env.local`
  - Can be cleaned with `make docker-clean-env` or `make clean`

## Variable Examples

Here is the typical content of a `.env.local` file:

```env
# Application
NODE_ENV=development
PORT=3000
APP_NAME=CareCore API

# Database
DB_TYPE=postgres
DB_HOST=localhost
DB_PORT=5432
DB_USER=
DB_PASSWORD=
DB_NAME=
DB_SYNCHRONIZE=false

# JWT
JWT_SECRET=
JWT_EXPIRATION=24h

# FHIR
FHIR_VERSION=R4
FHIR_BASE_URL=http://localhost:3000/api/fhir

# Security
BCRYPT_ROUNDS=10

# CORS
CORS_ORIGIN=http://localhost:3000

# Rate Limiting
RATE_LIMIT_TTL=60
RATE_LIMIT_MAX=100

# PgAdmin (Optional)
PGADMIN_EMAIL=
PGADMIN_PASSWORD=
PGADMIN_PORT=5050

# Keycloak
KEYCLOAK_ADMIN=
KEYCLOAK_ADMIN_PASSWORD=
KEYCLOAK_URL=http://localhost:8080
KEYCLOAK_REALM=carecore
KEYCLOAK_PORT=8080
```

## Variable Descriptions

### Application
- `NODE_ENV`: Runtime environment (`development`, `production`, `test`)
- `PORT`: Port where the application will run (default: 3000)
- `APP_NAME`: Application name

### Database
- `DB_TYPE`: Database type (currently only `postgres`)
- `DB_HOST`: PostgreSQL host (use `localhost` in development, service name in Docker)
- `DB_PORT`: PostgreSQL port (default: 5432)
- `DB_USER`: Database user
- `DB_PASSWORD`: Database password
- `DB_NAME`: Database name
- `DB_SYNCHRONIZE`: Automatically synchronize schema (only `true` in development)

### JWT
- `JWT_SECRET`: Secret key for signing JWT tokens (**change in production!**)
- `JWT_EXPIRATION`: Token expiration time (e.g., `24h`, `7d`)

### FHIR
- `FHIR_VERSION`: FHIR version (default: `R4`)
- `FHIR_BASE_URL`: Base URL for FHIR resources

### Security
- `BCRYPT_ROUNDS`: Number of rounds for password hashing (default: 10)

### CORS
- `CORS_ORIGIN`: Allowed origin for CORS (use `*` in development, specific in production)

### Rate Limiting
- `RATE_LIMIT_TTL`: Time window in seconds for rate limiting
- `RATE_LIMIT_MAX`: Maximum number of requests per window

### PgAdmin (Optional)
- `PGADMIN_EMAIL`: Email to access PgAdmin
- `PGADMIN_PASSWORD`: Password for PgAdmin
- `PGADMIN_PORT`: Port for PgAdmin (default: 5050)

### Keycloak
- `KEYCLOAK_ADMIN`: Username for Keycloak administrator (default: `admin`)
- `KEYCLOAK_ADMIN_PASSWORD`: Password for Keycloak administrator (**change in production!**)
- `KEYCLOAK_URL`: Base URL of Keycloak server
  - Development: `http://localhost:8080`
  - Production: `https://keycloak.yourdomain.com`
  - Docker internal: `http://keycloak:8080` (when API runs in Docker)
- `KEYCLOAK_REALM`: Name of the Keycloak realm (default: `carecore`)
- `KEYCLOAK_PORT`: Port where Keycloak runs (default: `8080`)

⚠️ **Security Notes for Keycloak:**
- Change `KEYCLOAK_ADMIN_PASSWORD` in production immediately
- Use strong passwords (minimum 16 characters, mix of letters, numbers, symbols)
- In production, use HTTPS for `KEYCLOAK_URL`
- Consider using environment-specific realms (e.g., `carecore-dev`, `carecore-prod`)

## Loading Priority

Environment variables are loaded in this order (the last one overrides the previous ones):

1. Operating system variables
2. `.env.development` or `.env.production` (according to `NODE_ENV`)
3. `.env.local` (overrides everything - for local values)

**Example:**
- `.env.development` has `DB_PORT=5432`
- `.env.local` has `DB_PORT=5433`
- **Result:** The application will use `DB_PORT=5433`

## Security Notes

⚠️ **IMPORTANT:**
- Never commit `.env.local`, `.env.development`, or `.env.production` files to the repository
- Only `.example` files should be in the repository
- Change all default passwords in production
- Use secure values for `JWT_SECRET` in production (minimum 32 random characters)
- In production, use SSL/TLS connections for the database
- Consider using a secrets manager (AWS Secrets Manager, HashiCorp Vault, etc.)
- Use `.env.local` for sensitive values you don't want to share with the team
